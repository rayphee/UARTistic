C51 COMPILER V9.53.0.0   EFM8BB3_UART_INTERRUPT                                            05/08/2017 18:34:15 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE EFM8BB3_UART_INTERRUPT
OBJECT MODULE PLACED IN .\src/EFM8BB3_UART_Interrupt.OBJ
COMPILER INVOKED BY: Z:\Applications\Simplicity Studio.app\Contents\Eclipse\developer\toolchains\keil_8051\9.53\BIN\C51.
                    -exe /Users/rafi/SimplicityStudio/v4_workspace/UARTisticFucK/src/EFM8BB3_UART_Interrupt.c OMF2 SMALL DEBUG OBJECTEXTEND R
                    -OM(LARGE) WARNINGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(8,SPEED) DEFINE(DEBUG=1) INTVECTOR(0X0000) INTPROMOTE INCDIR(/Users/raf
                    -i/SimplicityStudio/v4_workspace/UARTisticFucK/inc;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/80
                    -51/v4.0.3//kits/common/drivers/efm8_memory_lcd/inc/config;/Applications/Simplicity Studio.app/Contents/Eclipse/developer
                    -/sdks/8051/v4.0.3//kits/EFM8BB3_SLSTK2022A/config;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/80
                    -51/v4.0.3//kits/common/bsp;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//Device/EFM8B
                    -B3/peripheral_driver/inc;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//kits/common/dr
                    -ivers/efm8_memory_lcd/inc;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//kits/common/d
                    -rivers/efm8_memory_lcd/inc/graphics;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//kit
                    -s/common/drivers/efm8_joystick;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//Device/s
                    -hared/si8051base;/Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//Device/EFM8BB3/inc;/Ap
                    -plications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//kits/common/drivers/efm8_retargetserial) P
                    -RINT(.\src/EFM8BB3_UART_Interrupt.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src/EFM8BB3_UART_Interrupt.OBJ)

line level    source

   1          //-----------------------------------------------------------------------------
   2          // EFM8BB3_UART0_Interrupt.c
   3          //-----------------------------------------------------------------------------
   4          // Copyright 2014 Silicon Laboratories, Inc.
   5          // http://developer.silabs.com/legal/version/v11/Silicon_Labs_Software_License_Agreement.txt
   6          //
   7          // Program Description:
   8          //
   9          // This program demonstrates how to configure the EFM8BB3 to write to and
  10          // read from the UART0 interface. The program reads a word using the UART0
  11          // interrupt and outputs that word to the screen, with all characters in
  12          // uppercase.
  13          //
  14          // Resources:
  15          //   SYSCLK - 24.5 MHz HFOSC0 / 1
  16          //   UART0  - 115200 baud, 8-N-1
  17          //   Timer1 - UART0 clock source
  18          //   P0.4   - UART0 TX
  19          //   P0.5   - UART0 RX
  20          //   P2.2   - Board Controller enable
  21          //   P3.4   - Display enable
  22          //
  23          //-----------------------------------------------------------------------------
  24          // How To Test: EFM8BB3 STK
  25          //-----------------------------------------------------------------------------
  26          // 1) Place the switch in "AEM" mode.
  27          // 2) Connect the EFM8BB3 STK board to a PC using a mini USB cable.
  28          // 3) Compile and download code to the EFM8BB3 STK board.
  29          //    In Simplicity Studio IDE, select Run -> Debug from the menu bar,
  30          //    click the Debug button in the quick menu, or press F11.
  31          // 4) On the PC, open HyperTerminal (or any other terminal program) and connect
  32          //    to the JLink CDC UART Port at 115200 baud rate and 8-N-1.
  33          // 5) Run the code.
  34          //    In Simplicity Studio IDE, select Run -> Resume from the menu bar,
  35          //    click the Resume button in the quick menu, or press F8.
  36          // 6) Using a terminal program on the PC, input any number of lower-case
  37          //    characters, up to UART_BUFFERSIZE (default 64), followed by either
  38          //    a carriage return ('\r'), a newline character ('\n'), or a tilda ('~').
  39          //    The program will change the input characters to upper-case and output
  40          //    them over UART.
  41          //
  42          // Target:         EFM8BB3
  43          // Tool chain:     Generic
C51 COMPILER V9.53.0.0   EFM8BB3_UART_INTERRUPT                                            05/08/2017 18:34:15 PAGE 2   

  44          //
  45          // Release 0.1 (ST)
  46          //    - Initial Revision
  47          //    - 20 MAY 2015
  48          //
  49          
  50          //-----------------------------------------------------------------------------
  51          // Includes
  52          //-----------------------------------------------------------------------------
  53          #include <SI_EFM8BB3_Register_Enums.h>
  54          #include <SI_EFM8BB3_Defs.h>
  55          #include "retargetserial.h"
  56          #include "render.h"
*** WARNING C318 IN LINE 8 OF /Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//kits/comm
             -on/drivers/efm8_memory_lcd/inc/config\render_config.h: can't open file 'memory_lcd_config.h'
  57          #include "../lib/bsp/efm8_memory_lcd/inc/render-extended.h"
  58          #include "disp.h"
  59          #include "joystick.h"
*** WARNING C318 IN LINE 18 OF /Applications/Simplicity Studio.app/Contents/Eclipse/developer/sdks/8051/v4.0.3//kits/com
             -mon/drivers/efm8_joystick\joystick.h: can't open file 'joystick_config.h'
  60          #include "InitDevice.h"
  61          
  62          //-----------------------------------------------------------------------------
  63          // Pin Definitions
  64          //-----------------------------------------------------------------------------
  65          SI_SBIT (DISP_EN, SFR_P3, 4);          // Display Enable
  66          #define DISP_BC_DRIVEN   0             // 0 = Board Controller drives display
  67          #define DISP_EFM8_DRIVEN 1             // 1 = EFM8 drives display
  68          
  69          SI_SBIT (BC_EN, SFR_P2, 2);            // Board Controller Enable
  70          #define BC_DISCONNECTED 0              // 0 = Board Controller disconnected
  71                                                 //     to EFM8 UART pins
  72          #define BC_CONNECTED    1              // 1 = Board Controller connected
  73                                                 //     to EFM8 UART pins
  74          
  75          //-----------------------------------------------------------------------------
  76          // Global Variables
  77          //-----------------------------------------------------------------------------
  78          // Variables in Interrupts.c
  79          unsigned char xdata textBuffer[520] = {0};
  80          int bufOffset = 0;
  81          int bufLen = 0;
  82          char xdata thatDankDisplayShit[21];
  83          uint8_t scrollOffset = 0;
  84          int min(int a, int b){
  85   1              if(a<b) return a; else return b;
  86   1      }
  87          int max(int a, int b){
  88   1              if(a>b) return a; else return b;
  89   1      }
  90          //-----------------------------------------------------------------------------
  91          // Main Routine
  92          //-----------------------------------------------------------------------------
  93          static uint8_t getJoystick(void)
  94          {
  95   1        uint32_t mv;
  96   1        uint8_t dir;
  97   1      
  98   1        ADC0CN0_ADBUSY = 1;
  99   1        while (!ADC0CN0_ADINT);
 100   1        ADC0CN0_ADINT = 0;
 101   1      
 102   1        mv = ((uint32_t)ADC0) * 3300 / 1024;
C51 COMPILER V9.53.0.0   EFM8BB3_UART_INTERRUPT                                            05/08/2017 18:34:15 PAGE 3   

 103   1      
 104   1        dir = JOYSTICK_convert_mv_to_direction(mv);
 105   1      
 106   1        return dir;
 107   1      }
 108          
 109          //-----------------------------------------------------------------------------
 110          // getWaitJoystick
 111          //-----------------------------------------------------------------------------
 112          //
 113          // Get joystick input. If joystick was moved, wait for release. Return joystick
 114          // direction. Valid return values:
 115          //  JOYSTICK_NONE   JOYSTICK_N   JOYSTICK_S
 116          //  JOYSTICK_C      JOYSTICK_E   JOYSTICK_W
 117          //
 118          static uint8_t getWaitJoystick(void)
 119          {
 120   1        uint8_t dir, dirSave;
 121   1      
 122   1        dir = getJoystick();
 123   1        dirSave = dir;
 124   1      
 125   1        // wait for release then transition
 126   1        while (dir != JOYSTICK_NONE)
 127   1        {
 128   2          dir = getJoystick();
 129   2        }
 130   1      
 131   1        return dirSave;
 132   1      }
 133          
 134          static void processInput(uint8_t dir)
 135          {
 136   1        // process input
 137   1        if (dir == JOYSTICK_N)
 138   1        {
 139   2          //scrollOffset = (scrollOffset++)%5;
 140   2          P1_B6 = 0;
 141   2        }
 142   1        else if (dir == JOYSTICK_S)
 143   1        {
 144   2          P1_B6 = 0;
 145   2        }
 146   1        else{
 147   2                P1_B6 = 1;
 148   2                P1_B5 = 1;
 149   2        }
 150   1      }
 151          
 152          SI_INTERRUPT (UART0_ISR, UART0_IRQn)
 153          {
 154   1              int endOffset;
 155   1              if(P1_B4 == 0){
 156   2                              P1_B4 = 1;
 157   2                      }
 158   1                      else{
 159   2                              P1_B4 = 0;
 160   2                      }
 161   1              while(SCON0_RI) {
 162   2                              SCON0_RI = 0;
 163   2                              endOffset = (bufOffset + bufLen)%520;
 164   2                              textBuffer[endOffset] = SBUF0;
 165   2              if(bufLen < 520) bufLen++; else bufOffset++;
C51 COMPILER V9.53.0.0   EFM8BB3_UART_INTERRUPT                                            05/08/2017 18:34:15 PAGE 4   

 166   2                      }
 167   1      }
 168          
 169          void main (void)
 170          {
 171   1              uint8_t i;
 172   1              uint8_t j;
 173   1              uint8_t firstLine;
 174   1      
 175   1              bool hexModeStatus = false;
 176   1              bool lP0B2;
 177   1      
 178   1              enter_DefaultMode_from_RESET();
 179   1      
 180   1      
 181   1              DISP_EN = DISP_EFM8_DRIVEN;             // EFM8 drives display
 182   1      
 183   1              TMR2CN0 = 2;
 184   1      
 185   1              BC_EN = BC_DISCONNECTED;                // Board controller connected to EFM8
 186   1                                                 // UART pins
 187   1              IE_EA = 1;
 188   1      
 189   1              DISP_Init();
 190   1      
 191   1              while(1)
 192   1              {
 193   2                      //processInput(getWaitJoystick());
 194   2      
 195   2                      if (!P0_B2 && hexModeStatus) {
 196   3                              hexModeStatus = false;
 197   3                              lP0B2 = true;
 198   3                      }
 199   2                      else if(!P0_B2 && !hexModeStatus){
 200   3                              hexModeStatus = true;
 201   3                              lP0B2 = true;
 202   3                      }
 203   2                      else{
 204   3                              lP0B2 = false;
 205   3                      }
 206   2                      if (!hexModeStatus){
 207   3                              /*
 208   3                              for (j=0; j<(bufLen/20);j++){
 209   3                                      for (i=0;i<21;i++){
 210   3                                              thatDankDisplayShit[i]=textBuffer[(21*j)+(i+scrollOffset)];
 211   3                                      }
 212   3                                      renderAndWrite(0,8*j,0, thatDankDisplayShit);
 213   3                              }
 214   3                              */
 215   3                              firstLine = max(0,(bufLen-1)/20-15);
 216   3                              for(j=firstLine; j < min(firstLine+16,(bufLen-1)/20+1); j++){
 217   4                                      for(i = 0 ; i < 21; i++){
 218   5                                              // our offset in the buffer should be 20*j + i
 219   5                                              if(20*j + i > bufLen) thatDankDisplayShit[i] = 0;
 220   5                                              else thatDankDisplayShit[i] = textBuffer[(20*j + i)%520];
 221   5      
 222   5                                      }
 223   4                                      renderAndWrite(0, 8*(j-firstLine),0,thatDankDisplayShit);
 224   4                              }
 225   3                      }
 226   2                      else if (hexModeStatus) {
 227   3                              DISP_ClearAll();
 228   3                              renderAndWriteCenteredText(46, 1, "GOD MODE");
C51 COMPILER V9.53.0.0   EFM8BB3_UART_INTERRUPT                                            05/08/2017 18:34:15 PAGE 5   

 229   3                      }
 230   2              }
 231   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    512    ----
   CONSTANT SIZE    =      9    ----
   XDATA SIZE       =    541    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
